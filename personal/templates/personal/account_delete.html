{% extends "base.html" %}
{% load static %}

{% block seo %}
<title>Удаление аккаунта - Healthcare</title>
{% endblock seo %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/forms.css' %}" />
<link rel="stylesheet" href="{% static 'css/profile.css' %}" />
{% endblock styles %}

{% block content %}
<div class="delete-container">
    <h1>⚠️ Удаление аккаунта</h1>
    
    <div class="warning-message">
        <p><strong>Внимание!</strong></p>
        <p>Вы собираетесь удалить свой аккаунт.</p>
        <p>Это действие необратимо. Будут удалены:</p>
        <ul>
            <li>Ваш профиль</li>
            <li>Все ваши заявки</li>
            <li>История сообщений</li>
        </ul>
    </div>
    
    <form id="deleteForm" method="post" action="{% url 'personal:account_delete' %}">
        {% csrf_token %}
        <p style="text-align: center; margin-bottom: 20px;">
            Вы уверены, что хотите удалить аккаунт <strong>{{ user.username }}</strong>?
        </p>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-danger">Да, удалить аккаунт</button>
            <a href="{% url 'personal:profile' %}" class="btn btn-cancel">Отмена</a>
        </div>
    </form>

<script>
document.getElementById('deleteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const formData = new FormData(form);
    const csrfToken = formData.get('csrfmiddlewaretoken');
    
    fetch(form.action, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({})
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else if (response.ok) {
            return response.json().then(data => {
                if (data.success) {
                    window.location.href = data.redirect || '{% url "homepage" %}';
                } else {
                    alert('Ошибка при удалении аккаунта');
                }
            });
        } else {
            // Если редирект произошел, просто переходим на главную
            window.location.href = '{% url "homepage" %}';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // В случае ошибки все равно пытаемся перейти на главную
        window.location.href = '{% url "homepage" %}';
    });
});
</script>
</div>
{% endblock content %}
