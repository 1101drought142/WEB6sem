{% extends "base.html" %}
{% load static %}

{% block seo %}
<title>–ú–æ–∏ —á–∞—Ç—ã - Healthcare (–î–æ–∫—Ç–æ—Ä)</title>
{% endblock seo %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}" />
{% endblock styles %}

{% block content %}
<div class="chats-container">
    <div class="chats-sidebar">
        <div class="sidebar-header">
            <h2>–ú–æ–∏ —á–∞—Ç—ã</h2>
        </div>
        
        <div class="chat-list">
            {% if chats %}
                {% for chat in chats %}
                <a href="{% url 'chat:chat_detail' chat.pk %}" class="chat-item" data-chat-id="{{ chat.pk }}">
                    <div class="chat-item-header">
                        <div class="chat-title">{{ chat.request.title|truncatewords:5 }}</div>
                        {% if chat.unread_count > 0 %}
                            <span class="unread-badge" id="badge-{{ chat.pk }}">{{ chat.unread_count }}</span>
                        {% else %}
                            <span class="unread-badge" id="badge-{{ chat.pk }}" style="display: none;">0</span>
                        {% endif %}
                    </div>
                    <div class="chat-patient">
                        {{ chat.request.patient.username }}
                    </div>
                    <div class="chat-time" id="time-{{ chat.pk }}">
                        {{ chat.updated_at|date:"d.m.Y H:i" }}
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="empty-sidebar">
                    <p>üí¨</p>
                    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="chat-content">
        <div class="select-chat-message">
            <div class="select-chat-icon">üí¨</div>
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chats/list/`;
    let chatSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket
    function connectWebSocket() {
        chatSocket = new WebSocket(wsUrl);
        
        chatSocket.onopen = function(e) {
            console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –¥–ª—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤');
            reconnectAttempts = 0;
        };
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            handleWebSocketMessage(data);
        };
        
        chatSocket.onerror = function(e) {
            console.error('–û—à–∏–±–∫–∞ WebSocket:', e);
        };
        
        chatSocket.onclose = function(e) {
            console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
            
            // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * reconnectAttempts, 10000);
                console.log(`–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${delay}ms`);
                setTimeout(connectWebSocket, delay);
            }
        };
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç WebSocket
    function handleWebSocketMessage(data) {
        switch(data.type) {
            case 'connection_established':
                console.log(data.message);
                break;
                
            case 'new_chat_message':
                updateChatItem(data);
                break;
                
            case 'chat_updated':
                updateChatTime(data);
                break;
                
            case 'error':
                console.error('–û—à–∏–±–∫–∞:', data.message);
                break;
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —á–∞—Ç–∞ –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    function updateChatItem(data) {
        const chatItem = document.querySelector(`[data-chat-id="${data.chat_id}"]`);
        if (!chatItem) {
            // –ï—Å–ª–∏ —á–∞—Ç–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ, –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ
            console.log('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
        const badge = document.getElementById(`badge-${data.chat_id}`);
        if (badge) {
            const unreadCount = data.unread_count || 0;
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
        const timeElement = document.getElementById(`time-${data.chat_id}`);
        if (timeElement) {
            const date = data.updated_at ? new Date(data.updated_at) : (data.created_at ? new Date(data.created_at) : new Date());
            timeElement.textContent = formatDate(date);
        }
        
        // –í—ã–¥–µ–ª—è–µ–º —á–∞—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ (–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
        chatItem.style.backgroundColor = '#e3f2fd';
        chatItem.style.transition = 'background-color 0.3s';
        setTimeout(() => {
            chatItem.style.backgroundColor = '';
        }, 2000);
        
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —á–∞—Ç –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
        const chatList = document.querySelector('.chat-list');
        if (chatList && chatItem.parentNode === chatList) {
            chatList.insertBefore(chatItem, chatList.firstChild);
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —á–∞—Ç–∞
    function updateChatTime(data) {
        const timeElement = document.getElementById(`time-${data.chat_id}`);
        if (timeElement && data.updated_at) {
            const date = new Date(data.updated_at);
            timeElement.textContent = formatDate(date);
        }
        
        const badge = document.getElementById(`badge-${data.chat_id}`);
        if (badge) {
            const unreadCount = data.unread_count || 0;
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
    function formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}.${month}.${year} ${hours}:${minutes}`;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    connectWebSocket();
    
    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        if (chatSocket) {
            chatSocket.close();
        }
    });
});
</script>
{% endblock content %}
