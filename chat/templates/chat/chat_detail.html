{% extends "base.html" %}
{% load static %}

{% block seo %}
<title>–ß–∞—Ç - {{ chat.request.title }} - Healthcare</title>
{% endblock seo %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}" />
<link rel="stylesheet" href="{% static 'css/forms.css' %}" />
{% endblock styles %}

{% block content %}
<div class="chat-page-wrapper">
    {% if user.doctor %}
        <a href="{% url 'chat:doctor_requests' %}?filter=my" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞—è–≤–∫–∞–º</a>
    {% else %}
        <a href="{% url 'chat:patient_chats' %}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –º–æ–∏–º –∑–∞—è–≤–∫–∞–º</a>
    {% endif %}
</div>

<div class="chat-container">
    <div class="chat-header">
        <h2>{{ chat.request.title }}</h2>
        <div class="chat-info">
            {% if user.doctor %}
                –ü–∞—Ü–∏–µ–Ω—Ç: {{ chat.request.patient.username }}
            {% else %}
                –î–æ–∫—Ç–æ—Ä: {{ chat.request.doctor.get_full_name }}
            {% endif %}
            | –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: {{ chat.request.get_specialization_display }}
        </div>
    </div>
    
    <div class="messages-container" id="messages-container">
        {% if messages %}
            {% for message in messages %}
            <div class="message {% if message.sender == user %}own{% endif %}">
                <div class="message-bubble">
                    {% if message.sender != user %}
                        <div class="message-sender">
                            {% if message.sender.doctor %}
                                –î–æ–∫—Ç–æ—Ä {{ message.sender.doctor.get_full_name }}
                            {% else %}
                                {{ message.sender.username }}
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    {% if message.text %}
                        <div class="message-text">{{ message.text }}</div>
                    {% endif %}
                    
                    {% if message.file %}
                        <div class="message-file">
                            <a href="{{ message.file.url }}" target="_blank">
                                üìé {{ message.file.name|slice:"15:" }}
                            </a>
                        </div>
                    {% endif %}
                    
                    <div class="message-time">
                        {{ message.created_at|date:"d.m.Y H:i" }}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-chat">
                <div class="empty-chat-icon">üí¨</div>
                <h3>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h3>
                <p>–ü–æ–∫–∞ –∑–¥–µ—Å—å –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!</p>
            </div>
        {% endif %}
    </div>
    
    <div class="message-form">
        <form method="post" action="{% url 'chat:message_send' chat.pk %}" enctype="multipart/form-data" id="message-form">
            {% csrf_token %}
            
            <div class="message-input-wrapper">
                <textarea 
                    name="text" 
                    class="message-input" 
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                    id="message-input"
                    rows="1"
                ></textarea>
                
                <label class="file-input-label" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                    üìé
                    <input type="file" name="file" id="file-input">
                </label>
                
                <button type="submit" class="btn-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            
            <div id="file-preview" class="file-preview" style="display: none;"></div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ textarea
    const messageInput = document.getElementById('message-input');
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Ctrl/Cmd + Enter
    messageInput.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            document.getElementById('message-form').submit();
        }
    });
    
    // –ü—Ä–µ–≤—å—é –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const fileName = this.files[0].name;
            filePreview.textContent = `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${fileName}`;
            filePreview.style.display = 'block';
        } else {
            filePreview.style.display = 'none';
        }
    });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –±–µ–∑ WebSocket)
    // setInterval(() => {
    //     location.reload();
    // }, 30000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
});
</script>
{% endblock content %}
