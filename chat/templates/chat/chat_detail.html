{% extends "base.html" %}
{% load static %}

{% block seo %}
<title>–ß–∞—Ç - {{ chat.request.title }} - Healthcare</title>
{% endblock seo %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}" />
<link rel="stylesheet" href="{% static 'css/forms.css' %}" />
{% endblock styles %}

{% block content %}
<div class="chat-page-wrapper">
    {% if user.doctor %}
        <a href="{% url 'chat:doctor_requests' %}?filter=my" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞—è–≤–∫–∞–º</a>
    {% else %}
        <a href="{% url 'chat:patient_chats' %}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –º–æ–∏–º –∑–∞—è–≤–∫–∞–º</a>
    {% endif %}
</div>

<div class="chat-container">
    <div class="chat-header">
        <h2>{{ chat.request.title }}</h2>
        <div class="chat-info">
            {% if user.doctor %}
                –ü–∞—Ü–∏–µ–Ω—Ç: {{ chat.request.patient.username }}
            {% else %}
                –î–æ–∫—Ç–æ—Ä: {{ chat.request.doctor.get_full_name }}
            {% endif %}
            | –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: {{ chat.request.get_specialization_display }}
        </div>
    </div>
    
    <div class="messages-container" id="messages-container">
        {% if messages %}
            {% for message in messages %}
            <div class="message {% if message.sender == user %}own{% endif %}" data-message-id="{{ message.id }}">
                <div class="message-bubble">
                    {% if message.sender != user %}
                        <div class="message-sender">
                            {% if message.sender.doctor %}
                                –î–æ–∫—Ç–æ—Ä {{ message.sender.doctor.get_full_name }}
                            {% else %}
                                {{ message.sender.username }}
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    {% if message.text %}
                        <div class="message-text">{{ message.text }}</div>
                    {% endif %}
                    
                    {% if message.file %}
                        <div class="message-file">
                            <a href="{{ message.file.url }}" target="_blank">
                                üìé {{ message.file.name|slice:"15:" }}
                            </a>
                        </div>
                    {% endif %}
                    
                    <div class="message-time">
                        {{ message.created_at|date:"d.m.Y H:i" }}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-chat">
                <div class="empty-chat-icon">üí¨</div>
                <h3>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h3>
                <p>–ü–æ–∫–∞ –∑–¥–µ—Å—å –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!</p>
            </div>
        {% endif %}
        <div id="typing-indicator" class="typing-indicator" style="display: none;">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
            <span id="typing-user-name"></span> –ø–µ—á–∞—Ç–∞–µ—Ç...
        </div>
    </div>
    
    <div class="message-form">
        <form method="post" action="{% url 'chat:message_send' chat.pk %}" enctype="multipart/form-data" id="message-form">
            {% csrf_token %}
            
            <div class="message-input-wrapper">
                <textarea 
                    name="text" 
                    class="message-input" 
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                    id="message-input"
                    rows="1"
                ></textarea>
                
                <label class="file-input-label" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                    üìé
                    <input type="file" name="file" id="file-input">
                </label>
                
                <button type="submit" class="btn-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            
            <div id="file-preview" class="file-preview" style="display: none;"></div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatId = {{ chat.pk }};
    const currentUserId = {{ user.id }};
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const btnSend = document.querySelector('.btn-send');
    const typingIndicator = document.getElementById('typing-indicator');
    const typingUserName = document.getElementById('typing-user-name');
    
    let chatSocket = null;
    let typingTimeout = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º WebSocket URL
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chat/${chatId}/`;
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket
    function connectWebSocket() {
        chatSocket = new WebSocket(wsUrl);
        
        chatSocket.onopen = function(e) {
            console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
            reconnectAttempts = 0;
            updateConnectionStatus(true);
        };
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            handleWebSocketMessage(data);
        };
        
        chatSocket.onerror = function(e) {
            console.error('–û—à–∏–±–∫–∞ WebSocket:', e);
            updateConnectionStatus(false);
        };
        
        chatSocket.onclose = function(e) {
            console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
            updateConnectionStatus(false);
            
            // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * reconnectAttempts, 10000);
                console.log(`–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${delay}ms`);
                setTimeout(connectWebSocket, delay);
            } else {
                console.error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        };
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç WebSocket
    function handleWebSocketMessage(data) {
        switch(data.type) {
            case 'connection_established':
                console.log(data.message);
                break;
                
            case 'new_message':
                addMessageToChat(data, false);
                scrollToBottom();
                break;
                
            case 'message_sent':
                // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ - –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è
                console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', data.message_id);
                scrollToBottom();
                break;
                
            case 'typing':
                showTypingIndicator(data.username, data.is_typing);
                break;
                
            case 'error':
                console.error('–û—à–∏–±–∫–∞:', data.message);
                alert('–û—à–∏–±–∫–∞: ' + data.message);
                break;
        }
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
    function addMessageToChat(data, isOwn) {
        // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        const emptyChat = messagesContainer.querySelector('.empty-chat');
        if (emptyChat) {
            emptyChat.remove();
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isOwn ? 'own' : ''}`;
        messageDiv.setAttribute('data-message-id', data.message_id);
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'message-bubble';
        
        // –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å (–µ—Å–ª–∏ –Ω–µ —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
        if (!isOwn) {
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = data.sender_is_doctor 
                ? `–î–æ–∫—Ç–æ—Ä ${data.sender_full_name}` 
                : data.sender_username;
            bubbleDiv.appendChild(senderDiv);
        }
        
        // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        if (data.text) {
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = data.text;
            bubbleDiv.appendChild(textDiv);
        }
        
        // –§–∞–π–ª
        if (data.file_url) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'message-file';
            const fileLink = document.createElement('a');
            fileLink.href = data.file_url;
            fileLink.target = '_blank';
            fileLink.textContent = `üìé ${data.file_name || '–§–∞–π–ª'}`;
            fileDiv.appendChild(fileLink);
            bubbleDiv.appendChild(fileDiv);
        }
        
        // –í—Ä–µ–º—è
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        const date = new Date(data.created_at);
        timeDiv.textContent = formatDate(date);
        bubbleDiv.appendChild(timeDiv);
        
        messageDiv.appendChild(bubbleDiv);
        messagesContainer.insertBefore(messageDiv, typingIndicator);
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
    function formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}.${month}.${year} ${hours}:${minutes}`;
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    function showTypingIndicator(username, isTyping) {
        if (isTyping) {
            typingUserName.textContent = username;
            typingIndicator.style.display = 'block';
            scrollToBottom();
        } else {
            typingIndicator.style.display = 'none';
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
    function sendMessage(text, fileUrl = null) {
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                type: 'chat_message',
                text: text,
                file_url: fileUrl
            }));
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageInput.value = '';
            messageInput.style.height = 'auto';
            filePreview.style.display = 'none';
            fileInput.value = '';
            
            return true;
        } else {
            console.error('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
            return false;
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    function sendTypingIndicator(isTyping) {
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                type: 'typing',
                is_typing: isTyping
            }));
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const text = messageInput.value.trim();
        const file = fileInput.files[0];
        
        if (!text && !file) {
            return;
        }
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
        if (file) {
            messageForm.submit();
            return;
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ WebSocket
        if (sendMessage(text)) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
            addMessageToChat({
                message_id: 'temp-' + Date.now(),
                sender_id: currentUserId,
                sender_username: '{{ user.username }}',
                sender_is_doctor: {% if user.doctor %}true{% else %}false{% endif %},
                sender_full_name: '{% if user.doctor %}{{ user.doctor.get_full_name }}{% else %}{{ user.get_full_name|default:user.username }}{% endif %}',
                text: text,
                file_url: null,
                file_name: null,
                created_at: new Date().toISOString(),
                is_read: false
            }, true);
            scrollToBottom();
        } else {
            // Fallback –Ω–∞ –æ–±—ã—á–Ω—É—é —Ñ–æ—Ä–º—É
            messageForm.submit();
        }
    });
    
    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    messageInput.addEventListener('input', function() {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
        if (this.value.trim().length > 0) {
            sendTypingIndicator(true);
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º false
            typingTimeout = setTimeout(function() {
                sendTypingIndicator(false);
            }, 3000);
        } else {
            sendTypingIndicator(false);
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
        }
    });
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (–±–µ–∑ Shift)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            messageForm.dispatchEvent(new Event('submit'));
        }
    });
    
    // –ü—Ä–µ–≤—å—é —Ñ–∞–π–ª–∞
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const fileName = this.files[0].name;
            filePreview.textContent = `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${fileName}`;
            filePreview.style.display = 'block';
        } else {
            filePreview.style.display = 'none';
        }
    });
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    function scrollToBottom() {
        setTimeout(function() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    function updateConnectionStatus(connected) {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if (connected) {
            btnSend.disabled = false;
            btnSend.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
        } else {
            btnSend.disabled = true;
            btnSend.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    scrollToBottom();
    connectWebSocket();
    
    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        if (chatSocket) {
            chatSocket.close();
        }
        if (typingTimeout) {
            clearTimeout(typingTimeout);
        }
    });
});
</script>
{% endblock content %}
