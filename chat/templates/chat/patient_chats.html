{% extends "base.html" %}
{% load static %}

{% block seo %}
<title>–ú–æ–∏ –∑–∞—è–≤–∫–∏ - Healthcare</title>
{% endblock seo %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/requests.css' %}" />
<link rel="stylesheet" href="{% static 'css/pagination.css' %}" />
{% endblock styles %}

{% block content %}
<div class="requests-container">
    <div class="requests-header">
        <h1>üìã –ú–æ–∏ –∑–∞—è–≤–∫–∏</h1>
        <a href="{% url 'chat:request_create' %}" class="btn-create">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</a>
    </div>
    
    {% if requests %}
        <div class="requests-table">
            <table>
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</th>
                        <th>–î–æ–∫—Ç–æ—Ä</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in requests %}
                    <tr data-request-id="{{ request.id }}" {% if request.chat %}data-chat-id="{{ request.chat.pk }}"{% endif %}>
                        <td>{{ request.created_at|date:"d.m.Y H:i" }}</td>
                        <td><strong>{{ request.title }}</strong></td>
                        <td>{{ request.get_specialization_display }}</td>
                        <td id="doctor-{{ request.id }}">
                            {% if request.doctor %}
                                <span style="color: #4CAF50; font-weight: 600;">
                                    {{ request.doctor.get_full_name }}
                                </span>
                            {% else %}
                                <span style="color: #999;">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                            {% endif %}
                        </td>
                        <td id="status-{{ request.id }}">
                            {% if request.status == 'waiting' %}
                                <span class="status-badge status-waiting">
                                    ‚è≥ {{ request.get_status_display }}
                                </span>
                            {% elif request.status == 'assigned' %}
                                <span class="status-badge status-assigned">
                                    ‚úÖ {{ request.get_status_display }}
                                </span>
                            {% elif request.status == 'waiting_doctor' %}
                                <span class="status-badge status-waiting_doctor">
                                    üí¨ {{ request.get_status_display }}
                                </span>
                            {% elif request.status == 'doctor_replied' %}
                                <span class="status-badge status-doctor_replied">
                                    üì¨ {{ request.get_status_display }}
                                </span>
                            {% else %}
                                <span class="status-badge">
                                    {{ request.get_status_display }}
                                </span>
                            {% endif %}
                        </td>
                        <td id="actions-{{ request.id }}">
                            {% if request.chat %}
                                <a href="{% url 'chat:chat_detail' request.chat.pk %}" class="btn-chat">üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>
                            {% else %}
                                <span style="color: #999; font-size: 13px;">–û–∂–∏–¥–∞–Ω–∏–µ –¥–æ–∫—Ç–æ—Ä–∞...</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% include 'pagination.html' %}
        
    {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</h3>
            <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å –¥–æ–∫—Ç–æ—Ä–æ–º</p>
            <br>
            <a href="{% url 'chat:request_create' %}" class="btn-create">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</a>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chats/list/`;
    let chatSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    
    // –°—Ç–∞—Ç—É—Å—ã –∑–∞—è–≤–æ–∫
    const statusMap = {
        'waiting': { class: 'status-waiting', icon: '‚è≥', text: '–û–∂–∏–¥–∞–µ—Ç –¥–æ–∫—Ç–æ—Ä–∞' },
        'assigned': { class: 'status-assigned', icon: '‚úÖ', text: '–î–æ–∫—Ç–æ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω' },
        'waiting_doctor': { class: 'status-waiting_doctor', icon: 'üí¨', text: '–û–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞ –¥–æ–∫—Ç–æ—Ä–∞' },
        'doctor_replied': { class: 'status-doctor_replied', icon: 'üì¨', text: '–î–æ–∫—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏–ª' },
        'closed': { class: '', icon: '', text: '–ó–∞–∫—Ä—ã—Ç–∞' }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket
    function connectWebSocket() {
        chatSocket = new WebSocket(wsUrl);
        
        chatSocket.onopen = function(e) {
            console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –¥–ª—è —Å–ø–∏—Å–∫–∞ –∑–∞—è–≤–æ–∫');
            reconnectAttempts = 0;
        };
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            handleWebSocketMessage(data);
        };
        
        chatSocket.onerror = function(e) {
            console.error('–û—à–∏–±–∫–∞ WebSocket:', e);
        };
        
        chatSocket.onclose = function(e) {
            console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
            
            // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * reconnectAttempts, 10000);
                console.log(`–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${delay}ms`);
                setTimeout(connectWebSocket, delay);
            }
        };
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç WebSocket
    function handleWebSocketMessage(data) {
        switch(data.type) {
            case 'connection_established':
                console.log(data.message);
                break;
                
            case 'new_chat_message':
                updateRequestRow(data);
                break;
                
            case 'chat_updated':
                // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –∏–ª–∏ –¥—Ä—É–≥—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                break;
                
            case 'error':
                console.error('–û—à–∏–±–∫–∞:', data.message);
                break;
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∑–∞—è–≤–∫–∏ –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    function updateRequestRow(data) {
        // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –ø–æ chat_id
        const row = document.querySelector(`[data-chat-id="${data.chat_id}"]`);
        if (!row) {
            return;
        }
        
        const requestId = row.getAttribute('data-request-id');
        if (!requestId) {
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–î–æ–∫—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏–ª" –∏–ª–∏ "–û–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞ –¥–æ–∫—Ç–æ—Ä–∞"
        const statusElement = document.getElementById(`status-${requestId}`);
        if (statusElement) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
            // –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å - –¥–æ–∫—Ç–æ—Ä, —Å—Ç–∞—Ç—É—Å "–î–æ–∫—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏–ª"
            // –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å - –ø–∞—Ü–∏–µ–Ω—Ç, —Å—Ç–∞—Ç—É—Å "–û–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞ –¥–æ–∫—Ç–æ—Ä–∞"
            // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ —Å—Ç–∞–≤–∏–º "–î–æ–∫—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏–ª" –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
            const newStatus = 'doctor_replied';
            const statusInfo = statusMap[newStatus];
            
            statusElement.innerHTML = `
                <span class="status-badge ${statusInfo.class}">
                    ${statusInfo.icon} ${statusInfo.text}
                </span>
            `;
        }
        
        // –í—ã–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤–∏–∑—É–∞–ª—å–Ω–æ
        row.style.backgroundColor = '#e3f2fd';
        row.style.transition = 'background-color 0.3s';
        setTimeout(() => {
            row.style.backgroundColor = '';
        }, 2000);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    connectWebSocket();
    
    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        if (chatSocket) {
            chatSocket.close();
        }
    });
});
</script>
{% endblock content %}