{% extends "base.html" %}
{% load static %}

{% block seo %}
<title>{{ elem.name }} - Healthcare</title>
{% endblock seo %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/news.css' %}" />
{% endblock styles %}

{% block content %}
<div class="news-detail-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <header class="news-detail-header">
        <h1 class="news-detail-title">{{ elem.name }}</h1>
        <div class="news-detail-meta">
            {% if elem.category %}
            <span class="news-detail-meta-item">
                <span>üìÇ</span>
                <span>{{ elem.category.name }}</span>
            </span>
            {% endif %}
            {% if elem.updated_at %}
            <span class="news-detail-meta-item">
                <span>üìÖ</span>
                <span>{{ elem.updated_at|date:"d.m.Y" }}</span>
            </span>
            {% endif %}
            {% if elem.poll %}
            <span class="news-detail-meta-item">
                <span>üëç</span>
                <span>{{ elem.poll.likes }}</span>
            </span>
            {% endif %}
        </div>
    </header>

    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
    {% if elem.image %}
    <img src="{{ elem.image.url }}" alt="{{ elem.name }}" class="news-detail-image">
    {% endif %}

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <article class="news-detail-content">
        {{ elem.description|safe }}
    </article>

    <!-- –¢–µ–≥–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
    {% if elem.tags.all %}
    <div class="news-detail-tags" style="margin-top: 30px;">
        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
            {% for tag in elem.tags.all %}
            <span style="padding: 6px 14px; background: #f5f5f5; border-radius: 15px; font-size: 13px; color: #666;">
                üè∑Ô∏è {{ tag.name }}
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="news-detail-actions">
        <a href="{% url 'news' %}" class="news-back-button">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–æ–≤–æ—Å—Ç—è–º</a>
    </div>

    <!-- –û–ø—Ä–æ—Å (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
    {% if elem.poll %}
    {% csrf_token %}
    <div id="poll-container" style="margin-top: 40px; padding: 30px; background: #f9f9f9; border-radius: 10px; text-align: center;">
        <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">–ü–æ–Ω—Ä–∞–≤–∏–ª–∞—Å—å —Å—Ç–∞—Ç—å—è?</h3>
        <div style="display: flex; gap: 20px; justify-content: center; align-items: center;">
            <div style="text-align: center;">
                <button 
                    id="like-btn" 
                    onclick="vote('like')" 
                    class="vote-btn {% if current_vote == 'like' %}vote-btn-active{% endif %}"
                    style="font-size: 32px; margin-bottom: 10px; background: {% if current_vote == 'like' %}#c8e6c9{% else %}none{% endif %}; border: {% if current_vote == 'like' %}2px solid #4CAF50{% else %}none{% endif %}; cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; transform: {% if current_vote == 'like' %}scale(1.1){% else %}scale(1){% endif %};"
                    title="–ù—Ä–∞–≤–∏—Ç—Å—è">
                    üëç
                </button>
                <div id="likes-count" style="font-size: 24px; font-weight: 600; color: #4CAF50;">{{ elem.poll.likes }}</div>
                <div style="font-size: 12px; color: #999;">–ù—Ä–∞–≤–∏—Ç—Å—è</div>
            </div>
            <div style="width: 1px; height: 50px; background: #ddd;"></div>
            <div style="text-align: center;">
                <button 
                    id="dislike-btn" 
                    onclick="vote('dislike')" 
                    class="vote-btn {% if current_vote == 'dislike' %}vote-btn-active{% endif %}"
                    style="font-size: 32px; margin-bottom: 10px; background: {% if current_vote == 'dislike' %}#ffcdd2{% else %}none{% endif %}; border: {% if current_vote == 'dislike' %}2px solid #f44336{% else %}none{% endif %}; cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; transform: {% if current_vote == 'dislike' %}scale(1.1){% else %}scale(1){% endif %};"
                    title="–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è">
                    üëé
                </button>
                <div id="dislikes-count" style="font-size: 24px; font-weight: 600; color: #f44336;">{{ elem.poll.dislikes }}</div>
                <div style="font-size: 12px; color: #999;">–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è</div>
            </div>
        </div>
        <div id="poll-message" style="margin-top: 15px; font-size: 14px; color: #666; min-height: 20px;"></div>
    </div>
    {% endif %}
</div>

<script>
// –¢–µ–∫—É—â–∏–π –≥–æ–ª–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ —Å–µ—Ä–≤–µ—Ä–∞)
let currentVote = '{{ current_vote|default:"" }}' || null;

function updateButtonStyles() {
    const likeBtn = document.getElementById('like-btn');
    const dislikeBtn = document.getElementById('dislike-btn');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –æ–±–µ–∏—Ö –∫–Ω–æ–ø–æ–∫
    likeBtn.style.background = 'none';
    likeBtn.style.border = 'none';
    likeBtn.style.transform = 'scale(1)';
    dislikeBtn.style.background = 'none';
    dislikeBtn.style.border = 'none';
    dislikeBtn.style.transform = 'scale(1)';
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–ª–æ—Å–∞
    if (currentVote === 'like') {
        likeBtn.style.background = '#c8e6c9';
        likeBtn.style.border = '2px solid #4CAF50';
        likeBtn.style.transform = 'scale(1.1)';
    } else if (currentVote === 'dislike') {
        dislikeBtn.style.background = '#ffcdd2';
        dislikeBtn.style.border = '2px solid #f44336';
        dislikeBtn.style.transform = 'scale(1.1)';
    }
}

function vote(voteType) {
    const newsSlug = '{{ elem.slug }}';
    const likeBtn = document.getElementById('like-btn');
    const dislikeBtn = document.getElementById('dislike-btn');
    const messageDiv = document.getElementById('poll-message');
    const likesCount = document.getElementById('likes-count');
    const dislikesCount = document.getElementById('dislikes-count');
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
    likeBtn.disabled = true;
    dislikeBtn.disabled = true;
    likeBtn.style.opacity = '0.6';
    dislikeBtn.style.opacity = '0.6';
    messageDiv.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    messageDiv.style.color = '#666';
    
    // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     getCookie('csrftoken');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
    fetch(`/news_elem/${newsSlug}/vote/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
        },
        body: `vote_type=${voteType}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            likesCount.textContent = data.likes;
            dislikesCount.textContent = data.dislikes;
            messageDiv.textContent = data.message;
            messageDiv.style.color = '#4CAF50';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≥–æ–ª–æ—Å
            currentVote = data.current_vote;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
            updateButtonStyles();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            likeBtn.disabled = false;
            dislikeBtn.disabled = false;
            likeBtn.style.opacity = '1';
            dislikeBtn.style.opacity = '1';
        } else {
            messageDiv.textContent = data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
            messageDiv.style.color = '#f44336';
            likeBtn.disabled = false;
            dislikeBtn.disabled = false;
            likeBtn.style.opacity = '1';
            dislikeBtn.style.opacity = '1';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageDiv.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≥–æ–ª–æ—Å–∞';
        messageDiv.style.color = '#f44336';
        likeBtn.disabled = false;
        dislikeBtn.disabled = false;
        likeBtn.style.opacity = '1';
        dislikeBtn.style.opacity = '1';
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ –∏–∑ cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ hover –¥–ª—è –∫–Ω–æ–ø–æ–∫
document.addEventListener('DOMContentLoaded', function() {
    const likeBtn = document.getElementById('like-btn');
    const dislikeBtn = document.getElementById('dislike-btn');
    
    if (likeBtn) {
        likeBtn.addEventListener('mouseenter', function() {
            if (currentVote !== 'like') {
                this.style.background = '#e8f5e9';
            }
        });
        likeBtn.addEventListener('mouseleave', function() {
            if (currentVote !== 'like') {
                this.style.background = 'none';
            } else {
                this.style.background = '#c8e6c9';
            }
        });
    }
    
    if (dislikeBtn) {
        dislikeBtn.addEventListener('mouseenter', function() {
            if (currentVote !== 'dislike') {
                this.style.background = '#ffebee';
            }
        });
        dislikeBtn.addEventListener('mouseleave', function() {
            if (currentVote !== 'dislike') {
                this.style.background = 'none';
            } else {
                this.style.background = '#ffcdd2';
            }
        });
    }
});
</script>
{% endblock content %}